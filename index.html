<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta http-equiv="Permissions-Policy" content="ambient-light-sensor=(), speaker=(), vibrate=(), vr=()">
    <title>Andy's Calendar Utilities</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        .button:hover {
            background-color: #3367d6;
        }
        .button:active {
            background-color: #2851a3;
        }
        .button.config {
            background-color: #cd853f;
        }
        .button.config:hover {
            background-color: #b8722c;
        }
        .button.config:active {
            background-color: #a0621f;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-container {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        .tab-container {
            display: flex;
            background-color: #f1f3f4;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .tab {
            flex: 1;
            padding: 16px 24px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-bottom: 3px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tab:not(:last-child) {
            border-right: 1px solid #dee2e6;
        }
        .tab:hover {
            background: linear-gradient(145deg, #e9ecef, #dee2e6);
            color: #343a40;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        .tab.active {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            color: #2c5aa0;
            border-bottom: 3px solid #4285f4;
            box-shadow: 0 -2px 8px rgba(66, 133, 244, 0.15);
            transform: translateY(-2px);
        }
        .tab.active::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4285f4, #34a853);
            border-radius: 2px 2px 0 0;
        }
        .tab-content {
            display: none;
            background-color: #ffffff;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 0;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }
        .actions-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(108,117,125,0.2);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .actions-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(108,117,125,0.3);
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 180px;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            z-index: 1000;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        .dropdown-content.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        .dropdown-item.remove {
            color: #dc3545;
        }
        .dropdown-item.remove:hover {
            background-color: #fdf2f2;
        }
        .dropdown-item.add {
            color: #28a745;
        }
        .dropdown-item.add:hover {
            background-color: #f2f9f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Andy's Calendar Utilities</h1>
        
        <button class="button" onclick="handleNames()">
            Skip Levels
        </button>
        
        
    </div>

    <script>
        // Test that JavaScript is working
        console.log('JavaScript loaded successfully');
        
        // Test page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded successfully');
        });
        
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enhanced cache for Skip Levels list with timestamp
        let cachedNamesWithEvents = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
        
        function isCacheValid() {
            return cachedNamesWithEvents && cacheTimestamp && 
                   (Date.now() - cacheTimestamp) < CACHE_DURATION;
        }

        function handleNames() {
            console.log('Names button clicked');
            
            // Check if google.script.run is available
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                alert('Error: Google Apps Script not available. Make sure this is running as a deployed web app.');
                console.error('google.script.run not available');
                return;
            }
            
            // Show names management screen
            const container = document.querySelector('.container');
            container.style.maxWidth = '800px';
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 style="margin: 0;">Manage Skip Level Names</h1>
                    <button class="button" onclick="goBackToMenu()" style="background-color: #6c757d; width: auto; padding: 10px 20px; margin: 0;">
                        Back to Menu
                    </button>
                </div>
                
                <!-- Tab Navigation -->
                <div class="tab-container">
                    <button class="tab active" onclick="showTab('currentNames')">Current Names</button>
                    <button class="tab" onclick="showTab('uploadFile')">Upload Names from File</button>
                    <button class="tab" onclick="showTab('meetingSlots')">Meeting Slots</button>
                    <button class="tab" onclick="showTab('properties')">Properties</button>
                </div>
                
                <!-- Current Names Tab -->
                <div id="currentNamesTab" class="tab-content active">
                    <div style="padding: 24px; border-radius: 0 0 8px 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="margin: 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px;">Current Names</h2>
                            <div class="actions-dropdown">
                                <button class="actions-btn" onclick="toggleActionsDropdown()" style="background: linear-gradient(135deg, #17a2b8, #138496); min-width: 100px; white-space: nowrap;">
                                    Actions
                                    <span style="font-size: 10px;">‚ñº</span>
                                </button>
                                <div id="actionsDropdown" class="dropdown-content" style="min-width: 200px;">
                                    <div class="dropdown-item" onclick="refreshCurrentNames(); closeActionsDropdown();" style="white-space: nowrap;">
                                        <span>üîÑ</span> Refresh
                                    </div>
                                    <div class="dropdown-item add" onclick="addAllMeetings(); closeActionsDropdown();" style="white-space: nowrap;">
                                        <span>‚ûï</span> Add Missing Meetings
                                    </div>
                                    <div class="dropdown-item remove" onclick="deleteAllMeetings(); closeActionsDropdown();" style="white-space: nowrap;">
                                        <span>üóëÔ∏è</span> Delete All
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="namesList" style="background-color: #f9f9f9; padding: 15px; border-radius: 4px; min-height: 50px; margin-bottom: 20px;">
                            <div class="loading-container">
                                <div class="spinner"></div>
                                <p>Loading current names...</p>
                            </div>
                        </div>
                        
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; margin-bottom: 15px;">Add Individual Name:</h4>
                            <div style="display: flex; gap: 12px; align-items: end;">
                                <div style="flex: 1; min-width: 0;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Name:</label>
                                    <input type="text" id="newNameInput" placeholder="Enter name to add" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;" onkeypress="if(event.key==='Enter') addIndividualName()">
                                </div>
                                <div style="flex-shrink: 0;">
                                    <button class="button" onclick="addIndividualName()" style="background-color: #28a745; white-space: nowrap; padding: 8px 16px; margin: 0; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; width: 100px; text-align: center;">Add Name</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Names from File Tab -->
                <div id="uploadFileTab" class="tab-content">
                    <div style="padding: 24px; border-radius: 0 0 8px 8px;">
                        <h2 style="margin-top: 0; color: #333; border-bottom: 2px solid #4285f4; padding-bottom: 10px;">Upload Names from File</h2>
                        
                        <div style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <p style="color: #666; margin: 0 0 15px 0; text-align: center;">
                                Upload a text file containing names (one name per line)
                            </p>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="file" id="nameFileInput" accept=".txt,.text" style="flex: 1;">
                                <button class="button" onclick="processNameFile()" style="width: auto; padding: 10px 20px; margin: 0;">
                                    Upload and Process File
                                </button>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="button" onclick="clearAllNames()" style="background-color: #dc3545; width: auto; padding: 10px 20px;">
                                Clear All Names
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Meeting Slots Tab -->
                <div id="meetingSlotsTab" class="tab-content">
                    <div style="padding: 24px; border-radius: 0 0 8px 8px;">
                        <h2 style="margin-top: 0; color: #333; border-bottom: 2px solid #cd853f; padding-bottom: 10px;">Meeting Slots Configuration</h2>
                        <p style="color: #666; margin-bottom: 20px;">
                            Configure recurring meeting time slots for skip level meetings
                        </p>
                        
                        <div id="meetingSlotsList" style="margin-bottom: 20px;">
                            <div class="loading-container">
                                <div class="spinner"></div>
                                <p>Loading meeting slots...</p>
                            </div>
                        </div>
                        
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0;">Add New Meeting Slot:</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Day of Week:</label>
                                    <select id="newSlotDay" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Time:</label>
                                    <input type="time" id="newSlotTime" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Duration (mins):</label>
                                    <input type="number" id="newSlotDuration" placeholder="30" min="15" max="480" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                                <div>
                                    <button class="button" onclick="addMeetingSlot()" style="width: auto; padding: 10px 15px; margin: 0;">Add</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="button" onclick="saveConfiguration()" style="background-color: #28a745; width: auto; padding: 12px 30px;">
                                Save Configuration
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Properties Tab -->
                <div id="propertiesTab" class="tab-content">
                    <div style="padding: 24px; border-radius: 0 0 8px 8px;">
                        <h2 style="margin-top: 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px;">Application Properties</h2>
                        <p style="color: #666; margin-bottom: 20px;">
                            Configure application settings and properties
                        </p>
                        
                        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">Recurring Interval (weeks):</label>
                                    <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                                        Number of weeks between recurring skip level meetings (1-26)
                                    </p>
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <input type="number" id="recurringIntervalInput" min="1" max="26" value="8" 
                                               style="width: 80px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; text-align: center;"
                                               onchange="validateRecurringInterval()">
                                        <span style="color: #666; font-size: 14px;">weeks</span>
                                        <div id="recurringIntervalStatus" style="margin-left: 10px;"></div>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <button id="savePropertiesBtn" class="button" onclick="saveRecurringInterval()" 
                                            style="background-color: #28a745; width: auto; padding: 12px 24px; margin: 0;">
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="propertiesStatus" style="margin-top: 20px; padding: 15px; border-radius: 4px; display: none;">
                        </div>
                    </div>
                </div>
            `;
            
            // Check if we have valid cached data to avoid redundant searches
            if (isCacheValid()) {
                console.log('Using cached names data (valid for ' + Math.round((CACHE_DURATION - (Date.now() - cacheTimestamp)) / 1000) + ' more seconds)');
                displayCurrentNames(cachedNamesWithEvents);
            } else {
                console.log('Loading names - cache expired or missing');
                loadCurrentNames();
            }
            
            // Load meeting slots data for the Meeting Slots tab
            loadMeetingSlots();
            
            // Load properties data for the Properties tab
            loadCurrentProperties();
        }
        
        
        
        function processNameFile() {
            console.log('Processing name file');
            const fileInput = document.getElementById('nameFileInput');
            const file = fileInput.files[0];
            const uploadButton = document.querySelector('button[onclick="processNameFile()"]');
            
            if (!file) {
                alert('Please select a file first.');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.txt') && !file.name.toLowerCase().endsWith('.text')) {
                alert('Please select a text file (.txt or .text).');
                return;
            }
            
            // Show spinner on button and disable it
            const originalButtonText = uploadButton.innerHTML;
            uploadButton.innerHTML = '<div style="display: inline-flex; align-items: center; gap: 8px;"><div style="border: 2px solid #f3f3f3; border-top: 2px solid #4285f4; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>Processing...</div>';
            uploadButton.disabled = true;
            uploadButton.style.opacity = '0.7';
            uploadButton.style.cursor = 'not-allowed';
            
            const reader = new FileReader();
            // Helper function to restore button state
            function restoreButtonState() {
                uploadButton.innerHTML = originalButtonText;
                uploadButton.disabled = false;
                uploadButton.style.opacity = '1';
                uploadButton.style.cursor = 'pointer';
            }
            
            reader.onload = function(e) {
                const content = e.target.result;
                const names = content.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
                
                if (names.length === 0) {
                    restoreButtonState();
                    alert('No valid names found in the file.');
                    return;
                }
                
                console.log('Parsed names:', names);
                
                // Check for duplicates within the file
                const uniqueNames = [];
                const duplicatesInFile = [];
                const seenNames = new Set();
                
                names.forEach(name => {
                    const lowerName = name.toLowerCase();
                    if (seenNames.has(lowerName)) {
                        duplicatesInFile.push(name);
                    } else {
                        seenNames.add(lowerName);
                        uniqueNames.push(name);
                    }
                });
                
                if (duplicatesInFile.length > 0) {
                    restoreButtonState();
                    alert(`Error: The file contains duplicate names:\n${duplicatesInFile.join(', ')}\n\nPlease remove duplicates and try again.`);
                    return;
                }
                
                // Show loading state
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Saving ${uniqueNames.length} names and searching calendar events...</p>
                        <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                            This may take a moment while we search for existing calendar events
                        </div>
                    </div>
                `;
                
                // Get current names to check for duplicates
                google.script.run
                    .withSuccessHandler(function(currentNames) {
                        const duplicatesWithExisting = [];
                        const newNames = [];
                        
                        uniqueNames.forEach(name => {
                            if (currentNames.some(existing => existing.toLowerCase() === name.toLowerCase())) {
                                duplicatesWithExisting.push(name);
                            } else {
                                newNames.push(name);
                            }
                        });
                        
                        if (duplicatesWithExisting.length > 0) {
                            restoreButtonState();
                            loadCurrentNames();
                            alert(`Error: The following names already exist in the list:\n${duplicatesWithExisting.join(', ')}\n\nDuplicate names cannot be added.`);
                            return;
                        }
                        
                        if (newNames.length === 0) {
                            restoreButtonState();
                            loadCurrentNames();
                            alert('No new names to add - all names in the file already exist.');
                            return;
                        }
                        
                        // Combine existing names with new names
                        const allNames = [...currentNames, ...newNames];
                        
                        // Save the new names with calendar search
                        google.script.run
                            .withSuccessHandler(function(result) {
                                console.log('Names with calendar data saved successfully:', result);
                                restoreButtonState();
                                cachedNamesWithEvents = null; // Clear cache to force reload
                                loadCurrentNames();
                                alert(`Successfully added ${newNames.length} new names with calendar event search!`);
                            })
                            .withFailureHandler(function(error) {
                                console.error('Error saving names with calendar data:', error);
                                restoreButtonState();
                                alert('Error saving names with calendar data: ' + (error.message || error.toString()));
                                loadCurrentNames();
                            })
                            .saveSkipLevelNames(allNames);
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error getting current names:', error);
                        restoreButtonState();
                        alert('Error checking for duplicates: ' + (error.message || error.toString()));
                        loadCurrentNames();
                    })
                    .getSkipLevelNames();
            };
            
            reader.onerror = function() {
                restoreButtonState();
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsText(file);
        }
        
        function loadCurrentNames() {
            console.log('Loading current names with calendar events');
            
            // Show loading spinner while waiting for complete calendar search
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Searching calendar for Skip Level meetings...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        Please wait while we check your calendar events
                    </div>
                </div>
            `;
            
            // Load names with complete calendar data before displaying
            google.script.run
                .withSuccessHandler(function(namesWithEvents) {
                    console.log('Complete calendar data loaded:', namesWithEvents);
                    
                    if (!namesWithEvents || namesWithEvents.length === 0) {
                        document.getElementById('namesList').innerHTML = `
                            <div style="color: #666; text-align: center; font-style: italic;">
                                No names currently loaded. Upload a text file to get started.
                            </div>
                        `;
                        cachedNamesWithEvents = [];
                        cacheTimestamp = Date.now();
                        return;
                    }
                    
                    // Display complete results with calendar data
                    cachedNamesWithEvents = namesWithEvents;
                    cacheTimestamp = Date.now();
                    displayCurrentNames(namesWithEvents);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading names with calendar events:', error);
                    document.getElementById('namesList').innerHTML = `
                        <div style="color: red; text-align: center;">
                            Error loading names: ${error.message || error.toString()}
                        </div>
                    `;
                })
                .getNamesWithCalendarEvents();
        }
        
        function toggleActionsDropdown() {
            const dropdown = document.getElementById('actionsDropdown');
            const allDropdowns = document.querySelectorAll('.dropdown-content');
            
            // Close all other dropdowns first
            allDropdowns.forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                }
            });
            
            // Toggle this dropdown
            dropdown.classList.toggle('show');
        }
        
        function closeActionsDropdown() {
            const dropdown = document.getElementById('actionsDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }
        
        function refreshCurrentNames() {
            console.log('Refreshing current names with calendar events');
            cachedNamesWithEvents = null; // Clear cache to force reload
            cacheTimestamp = null; // Clear cache timestamp
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Refreshing names with calendar data...</p>
                </div>
            `;
            
            loadCurrentNames();
        }
        
        function addAllMeetings() {
            console.log('Add all meetings requested');
            
            if (!cachedNamesWithEvents || cachedNamesWithEvents.length === 0) {
                alert('No names loaded. Please refresh the list first.');
                return;
            }
            
            // Only include names that don't have calendar meeting links (found: false)
            const namesWithoutMeetings = cachedNamesWithEvents.filter(nameData => !nameData.found);
            
            if (namesWithoutMeetings.length === 0) {
                alert('All names already have recurring meetings. No new meetings to create.');
                return;
            }
            
            // Extract just the names for the backend
            const namesToProcess = namesWithoutMeetings.map(nameData => nameData.name);
            
            console.log('Names without meetings to process:', namesToProcess);
            
            // Show detailed confirmation
            const confirmMessage = `Create recurring meetings for names without calendar links?\n\n` +
                                 `Names that will get new meetings: ${namesWithoutMeetings.length}\n` +
                                 `‚Ä¢ ${namesWithoutMeetings.map(n => n.name).join('\\n‚Ä¢ ')}\n\n` +
                                 `This will:\n` +
                                 `‚Ä¢ Search for available meeting slots across the next several weeks\n` +
                                 `‚Ä¢ Create recurring Skip Level meetings for each name\n` +
                                 `‚Ä¢ Schedule meetings based on your configured meeting slots\n\n` +
                                 `Continue with bulk meeting creation?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Creating recurring meetings for ${namesWithoutMeetings.length} names...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        This may take a moment as we search for available slots...
                    </div>
                </div>
            `;
            
            // Call backend with the specific names to process
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('All meetings created successfully:', result);
                    
                    // Clear cache and refresh the list
                    cachedNamesWithEvents = null;
                    cacheTimestamp = null;
                    
                    // Show success message
                    let successMessage = `‚úì Bulk meeting creation completed!\n\n`;
                    successMessage += `Summary:\n`;
                    successMessage += `‚Ä¢ Names processed: ${result.namesProcessed}\n`;
                    successMessage += `‚Ä¢ Meetings created: ${result.meetingsCreated}\n`;
                    successMessage += `‚Ä¢ Names with no available slots: ${result.namesWithoutSlots}\n`;
                    successMessage += `‚Ä¢ Weeks calculated for recurrence: ${result.weeksCalculated}`;
                    
                    if (result.errors && result.errors.length > 0) {
                        successMessage += `\n\nWarnings:\n`;
                        successMessage += `‚Ä¢ ${result.errors.join('\\n‚Ä¢ ')}`;
                    }
                    
                    alert(successMessage);
                    
                    // Refresh the names list to show updated status
                    loadCurrentNames();
                })
                .withFailureHandler(function(error) {
                    console.error('Error creating all meetings:', error);
                    alert('Error creating meetings: ' + (error.message || error.toString()));
                    
                    // Refresh the names list anyway
                    loadCurrentNames();
                })
                .createMeetingsForSpecificNames(namesToProcess);
        }
        
        function deleteAllMeetings() {
            console.log('Delete all requested - clearing names list and calendar events');
            
            if (!cachedNamesWithEvents || cachedNamesWithEvents.length === 0) {
                alert('No names loaded. Please refresh the list first.');
                return;
            }
            
            const totalNames = cachedNamesWithEvents.length;
            const namesWithMeetings = cachedNamesWithEvents.filter(nameData => nameData.found);
            
            // Show detailed confirmation
            const confirmMessage = `‚ö†Ô∏è CRITICAL WARNING ‚ö†Ô∏è\n\n` +
                                 `This action will:\n` +
                                 `‚Ä¢ DELETE ALL ${totalNames} names from the list\n` +
                                 `‚Ä¢ DELETE ALL recurring Skip Level calendar events\n\n` +
                                 `Names to be removed: ${totalNames}\n` +
                                 `‚Ä¢ ${cachedNamesWithEvents.map(n => n.name).join('\\n‚Ä¢ ')}\n\n` +
                                 `Calendar events to be deleted: ${namesWithMeetings.length} recurring series\n\n` +
                                 `THIS WILL COMPLETELY CLEAR EVERYTHING AND CANNOT BE UNDONE!\n\n` +
                                 `Are you absolutely certain you want to proceed?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Final confirmation
            if (!confirm(`FINAL CONFIRMATION:\n\nClear ALL names and delete ALL calendar events?\n\nThis is your LAST CHANCE to cancel!`)) {
                return;
            }
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Clearing all names and deleting calendar events...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        This may take a moment. Please wait...
                    </div>
                </div>
            `;
            
            // First delete all meetings, then clear names
            google.script.run
                .withSuccessHandler(function(deleteResult) {
                    console.log('All meetings deleted successfully:', deleteResult);
                    
                    // Now clear all names
                    google.script.run
                        .withSuccessHandler(function(clearResult) {
                            console.log('All names cleared successfully:', clearResult);
                            
                            // Clear cache and refresh the list
                            cachedNamesWithEvents = null;
                            cacheTimestamp = null;
                            
                            // Show success message
                            let successMessage = `‚úì Successfully cleared everything!\n\n`;
                            successMessage += `Summary:\n`;
                            successMessage += `‚Ä¢ Names cleared: ${totalNames}\n`;
                            successMessage += `‚Ä¢ Calendar events deleted: ${deleteResult.meetingsDeleted}\n`;
                            
                            if (deleteResult.errors && deleteResult.errors.length > 0) {
                                successMessage += `\n\nWarnings:\n`;
                                successMessage += `‚Ä¢ ${deleteResult.errors.join('\\n‚Ä¢ ')}`;
                            }
                            
                            alert(successMessage);
                            
                            // Refresh the names list to show updated status
                            loadCurrentNames();
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error clearing names:', error);
                            alert('Error clearing names: ' + (error.message || error.toString()));
                            loadCurrentNames();
                        })
                        .clearSkipLevelNames();
                })
                .withFailureHandler(function(error) {
                    console.error('Error deleting calendar events:', error);
                    alert('Error deleting calendar events: ' + (error.message || error.toString()));
                    loadCurrentNames();
                })
                .deleteAllRecurringMeetings();
        }
        
        function displayCurrentNames(namesWithEvents) {
            console.log('displayCurrentNames called with:', namesWithEvents);
            const namesList = document.getElementById('namesList');
            
            if (!namesWithEvents || namesWithEvents.length === 0) {
                namesList.innerHTML = `
                    <div style="color: #666; text-align: center; font-style: italic;">
                        No names currently loaded. Upload a text file to get started.
                    </div>
                `;
            } else {
                console.log('Processing', namesWithEvents.length, 'names for display');
                // Sort names alphabetically by name property
                let sortedNamesWithEvents;
                try {
                    sortedNamesWithEvents = [...namesWithEvents].sort((a, b) => {
                        if (!a.name || !b.name) {
                            console.warn('Name data missing:', a, b);
                            return 0;
                        }
                        return a.name.localeCompare(b.name);
                    });
                } catch (error) {
                    console.error('Error sorting names:', error);
                    sortedNamesWithEvents = [...namesWithEvents];
                }
                
                let html = `
                    <div style="margin-bottom: 15px; font-weight: bold; color: #333;">
                        ${namesWithEvents.length} name(s) loaded (sorted alphabetically):
                    </div>
                `;
                
                sortedNamesWithEvents.forEach((nameData, index) => {
                    try {
                        console.log('Processing name data:', nameData);
                        if (!nameData || !nameData.name) {
                            console.warn('Invalid name data at index', index, ':', nameData);
                            return;
                        }
                        
                        const backgroundColor = index % 2 === 0 ? '#fbfcfd' : '#ffffff';
                        const borderColor = nameData.found ? '#d4edda' : '#f8d7da';
                        const leftBorderColor = nameData.found ? '#28a745' : '#dc3545';
                    
                    // Determine calendar status display
                    let calendarStatus = '';
                    let statusIcon = '';
                    if (nameData.found && nameData.nextOccurrence) {
                        statusIcon = '<span style="color: #28a745; font-size: 14px; margin-right: 8px;">‚úì</span>';
                        // Remove any bracketed timezone information from display
                        const cleanNextOccurrence = nameData.nextOccurrence.replace(/\s*\([^)]*\)/g, '');
                        calendarStatus = `<span style="color: #6c757d; margin-right: 6px;">Next occurrence:</span><a href="${nameData.calendarLink}" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: 500;">üìÖ ${cleanNextOccurrence}</a>`;
                    } else {
                        statusIcon = '<span style="color: #dc3545; font-size: 14px; margin-right: 8px;">‚úó</span>';
                        calendarStatus = '<span style="color: #6c757d; font-style: italic;">No meeting scheduled</span>';
                    }
                    
                    html += `
                        <div style="border: 1px solid ${borderColor}; border-left: 4px solid ${leftBorderColor}; border-radius: 6px; padding: 12px 16px; margin-bottom: 8px; background-color: ${backgroundColor}; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <div style="display: flex; align-items: center; min-width: 180px;">
                                        <span style="font-weight: 600; color: #2c3e50; font-size: 15px;">${escapeHtml(nameData.name)}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; flex: 1; justify-content: flex-end; margin-right: 20px;">
                                        ${statusIcon}
                                        <span style="font-size: 14px;">${calendarStatus}</span>
                                    </div>
                                </div>
                                <div style="flex-shrink: 0;">
                                    <div class="actions-dropdown">
                                        <button class="actions-btn" onclick="toggleDropdown('${escapeHtml(nameData.name).replace(/'/g, "\\'")}')">
                                            Actions
                                            <span style="font-size: 10px;">‚ñº</span>
                                        </button>
                                        <div id="dropdown-${escapeHtml(nameData.name).replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '')}" class="dropdown-content">
                                            ${!nameData.found ? 
                                                `<div class="dropdown-item add" onclick="addRecurringMeeting('${escapeHtml(nameData.name).replace(/'/g, "\\'")}')">
                                                    <span>‚ûï</span> Add Recurring Meeting
                                                </div>` : ''
                                            }
                                            <div class="dropdown-item remove" onclick="removeIndividualName('${escapeHtml(nameData.name).replace(/'/g, "\\'")}')">
                                                <span>üóëÔ∏è</span> Remove
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    } catch (error) {
                        console.error('Error processing name data at index', index, ':', error, nameData);
                    }
                });
                
                namesList.innerHTML = html;
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', function(event) {
                    if (!event.target.matches('.actions-btn')) {
                        const dropdowns = document.querySelectorAll('.dropdown-content');
                        dropdowns.forEach(dropdown => {
                            dropdown.classList.remove('show');
                        });
                    }
                });
            }
        }
        
        function toggleDropdown(name) {
            // Close all other dropdowns first
            const allDropdowns = document.querySelectorAll('.dropdown-content');
            allDropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // Generate the same ID as used in the HTML
            const dropdownId = 'dropdown-' + name.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            const dropdown = document.getElementById(dropdownId);
            
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        function addRecurringMeeting(name) {
            // Close the dropdown
            const dropdownId = 'dropdown-' + name.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            console.log('Adding recurring meeting for:', name);
            
            // Show confirmation dialog
            const confirmMessage = `Add a recurring meeting for "${name}"?\n\n` +
                                 `This will:\n` +
                                 `‚Ä¢ Search for available meeting slots in your calendar\n` +
                                 `‚Ä¢ Create a recurring Skip Level meeting\n` +
                                 `‚Ä¢ Schedule meetings based on configured meeting slots\n\n` +
                                 `Continue?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Creating recurring meeting for "${name}"...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        Calculating schedule and checking calendar availability
                    </div>
                </div>
            `;
            
            // Call backend to create the recurring meeting
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Recurring meeting created successfully:', result);
                    
                    // Show success message
                    let successMessage = `‚úì Recurring meeting created successfully for "${name}"!\n\n`;
                    
                    if (result.meetingCreated) {
                        successMessage += `Meeting Details:\n`;
                        successMessage += `‚Ä¢ Day: ${result.meetingDetails.dayOfWeek}\n`;
                        successMessage += `‚Ä¢ Time: ${result.meetingDetails.time}\n`;
                        successMessage += `‚Ä¢ Duration: ${result.meetingDetails.duration} minutes\n`;
                        successMessage += `‚Ä¢ Frequency: Every ${result.weeksCalculated} weeks\n`;
                        successMessage += `‚Ä¢ Title: Skip Level: ${name}`;
                    } else {
                        successMessage += `No available slots found in the next ${result.weeksCalculated} weeks.\n`;
                        successMessage += `Please check your meeting slot configuration or calendar availability.`;
                    }
                    
                    alert(successMessage);
                    
                    // Return to current names list and refresh to show updated calendar status
                    cachedNamesWithEvents = null; // Clear cache to force calendar search
                    loadCurrentNames();
                })
                .withFailureHandler(function(error) {
                    console.error('Error creating recurring meeting:', error);
                    alert('Error creating recurring meeting: ' + (error.message || error.toString()));
                    
                    // Refresh the names list on error
                    loadCurrentNames();
                })
                .createRecurringMeeting(name);
        }
        
        function clearAllNames() {
            if (!confirm('Are you sure you want to clear all loaded names? This action cannot be undone.')) {
                return;
            }
            
            console.log('Clearing all names');
            
            // Get the clear button and show spinner
            const clearButton = document.querySelector('button[onclick="clearAllNames()"]');
            const originalButtonText = clearButton.innerHTML;
            
            // Show spinner on button and disable it
            clearButton.innerHTML = '<div style="display: inline-flex; align-items: center; gap: 8px;"><div style="border: 2px solid #f3f3f3; border-top: 2px solid #dc3545; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>Clearing...</div>';
            clearButton.disabled = true;
            clearButton.style.opacity = '0.7';
            clearButton.style.cursor = 'not-allowed';
            
            // Helper function to restore button state
            function restoreButtonState() {
                clearButton.innerHTML = originalButtonText;
                clearButton.disabled = false;
                clearButton.style.opacity = '1';
                clearButton.style.cursor = 'pointer';
            }
            
            // Show loading state in the names list as well
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Clearing all names...</p>
                </div>
            `;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Names cleared successfully');
                    restoreButtonState();
                    cachedNamesWithEvents = null; // Clear cache
                    loadCurrentNames();
                    alert('All names have been cleared.');
                })
                .withFailureHandler(function(error) {
                    console.error('Error clearing names:', error);
                    restoreButtonState();
                    alert('Error clearing names: ' + (error.message || error.toString()));
                    loadCurrentNames();
                })
                .clearSkipLevelNames();
        }
        
        function removeIndividualName(nameToRemove) {
            console.log('Removing individual name:', nameToRemove);
            
            // Use cached data if available, otherwise get fresh data
            if (!cachedNamesWithEvents || cachedNamesWithEvents.length === 0) {
                console.log('No cached data available, refreshing...');
                // Show loading and refresh data
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading current data...</p>
                    </div>
                `;
                loadCurrentNames();
                return;
            }
            
            const currentNamesWithEvents = [...cachedNamesWithEvents];
            const nameToRemoveData = currentNamesWithEvents.find(nameData => nameData.name === nameToRemove);
            const hasCalendarEvent = nameToRemoveData ? nameToRemoveData.found : false;
            
            // Show immediate warning message
            let confirmMessage = `‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\nThis action will remove "${nameToRemove}" from the names list.`;
            
            if (hasCalendarEvent) {
                // Name has calendar events - warn about calendar deletion
                confirmMessage = `‚ö†Ô∏è IMPORTANT WARNING ‚ö†Ô∏è\n\n` +
                               `This action will:\n` +
                               `‚Ä¢ Remove "${nameToRemove}" from the names list\n` +
                               `‚Ä¢ DELETE all Skip Level calendar events for "${nameToRemove}"\n` +
                               `‚Ä¢ DELETE all future occurrences of these meetings\n\n` +
                               `This action CANNOT be undone!\n\n` +
                               `Are you absolutely sure you want to proceed?`;
            } else {
                confirmMessage += `\n\nAre you sure you want to proceed?`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            if (hasCalendarEvent) {
                // Name has calendar events - use the full removeSkipLevel function
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Removing "${nameToRemove}" and calendar events...</p>
                    </div>
                `;
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Name and calendar events removed successfully:', result);
                        
                        // Custom success handler to refresh the list and show confirmation
                        google.script.run
                            .withSuccessHandler(function(updatedNamesWithEvents) {
                                console.log('Names list refreshed after removing');
                                displayCurrentNames(updatedNamesWithEvents);
                                
                                // Show detailed success message
                                let successMessage = `‚úì "${nameToRemove}" has been successfully removed from the list.`;
                                if (result.deletedEventCount > 0) {
                                    successMessage += `\n\n${result.deletedEventCount} calendar event(s) were also deleted.`;
                                }
                                
                                setTimeout(() => {
                                    alert(successMessage);
                                }, 100);
                            })
                            .withFailureHandler(function(error) {
                                console.error('Error refreshing names list:', error);
                                alert('Name and calendar events were removed but there was an error refreshing the list: ' + (error.message || error.toString()));
                            })
                            .getNamesWithCalendarEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error removing name and calendar events:', error);
                        alert('Error removing name and calendar events: ' + (error.message || error.toString()));
                        loadCurrentNames();
                    })
                    .removeSkipLevel(nameToRemove);
            } else {
                // Name has no calendar events - optimize for local removal
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Removing "${nameToRemove}" from list...</p>
                    </div>
                `;
                
                // Remove the name from the local list
                const updatedNamesWithEvents = currentNamesWithEvents.filter(nameData => nameData.name !== nameToRemove);
                
                // Extract just the names for saving
                const updatedNames = updatedNamesWithEvents.map(nameData => nameData.name);
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Name removed successfully');
                        
                        // Update cache with the updated data
                        cachedNamesWithEvents = updatedNamesWithEvents;
                        
                        // Display the updated list locally (this will sort alphabetically)
                        displayCurrentNames(updatedNamesWithEvents);
                        
                        // Show success message
                        setTimeout(() => {
                            alert(`‚úì "${nameToRemove}" has been successfully removed from the list.`);
                        }, 100);
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error saving updated names:', error);
                        // Redisplay the original list from what was shown before
                        displayCurrentNames(currentNamesWithEvents);
                        alert('Error removing name: ' + (error.message || error.toString()));
                    })
                    .saveSkipLevelNames(updatedNames);
            }
        }
        
        function addIndividualName() {
            const nameInput = document.getElementById('newNameInput');
            const newName = nameInput.value.trim();
            
            if (!newName) {
                alert('Please enter a name.');
                return;
            }
            
            console.log('Adding individual name:', newName);
            
            // Use cached data if available, otherwise get fresh data
            if (!cachedNamesWithEvents) {
                console.log('No cached data available, refreshing...');
                // Show loading and refresh data
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading current data...</p>
                    </div>
                `;
                loadCurrentNames();
                return;
            }
            
            const currentNamesWithEvents = [...cachedNamesWithEvents];
            
            // Check if name already exists
            const existingName = currentNamesWithEvents.find(nameData => nameData.name === newName);
            if (existingName) {
                alert(`"${newName}" is already in the list.`);
                return;
            }
            
            // Show brief spinner
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Adding "${newName}" and searching calendar...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        Searching for existing calendar events
                    </div>
                </div>
            `;
            
            // Disable the add button and input
            const addButton = document.querySelector('button[onclick="addIndividualName()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Adding...';
            addButton.disabled = true;
            nameInput.disabled = true;
            
            // Extract just the names for saving
            const currentNames = currentNamesWithEvents.map(nameData => nameData.name);
            const updatedNames = [...currentNames, newName];
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Name added successfully with calendar search');
                    
                    // Clear cache to force reload from sheet with calendar data
                    cachedNamesWithEvents = null;
                    cacheTimestamp = null;
                    
                    // Reset form
                    addButton.textContent = originalText;
                    addButton.disabled = false;
                    nameInput.disabled = false;
                    nameInput.value = ''; // Clear the input
                    
                    // Reload the current names to show updated calendar data
                    loadCurrentNames();
                    
                    // Show success message
                    setTimeout(() => {
                        alert(`‚úì "${newName}" has been successfully added with calendar event search.`);
                    }, 100);
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving updated names:', error);
                    addButton.textContent = originalText;
                    addButton.disabled = false;
                    nameInput.disabled = false;
                    // Redisplay the original list from what was shown before
                    displayCurrentNames(currentNamesWithEvents);
                    alert('Error adding name: ' + (error.message || error.toString()));
                })
                .saveSkipLevelNames(updatedNames);
        }
        
        
        // Global variable to store meeting slots
        let currentMeetingSlots = [];
        
        // Global variable to track unsaved changes
        let hasUnsavedChanges = false;
        let originalMeetingSlots = [];
        
        function markUnsavedChanges() {
            hasUnsavedChanges = true;
        }
        
        function clearUnsavedChanges() {
            hasUnsavedChanges = false;
            originalMeetingSlots = JSON.parse(JSON.stringify(currentMeetingSlots));
        }
        
        function checkForUnsavedChanges() {
            return JSON.stringify(currentMeetingSlots) !== JSON.stringify(originalMeetingSlots);
        }
        
        function loadMeetingSlots() {
            console.log('Loading meeting slots');
            google.script.run
                .withSuccessHandler(function(slots) {
                    console.log('Loaded meeting slots:', slots);
                    currentMeetingSlots = slots || [];
                    originalMeetingSlots = JSON.parse(JSON.stringify(currentMeetingSlots));
                    hasUnsavedChanges = false;
                    displayMeetingSlots();
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading meeting slots:', error);
                    document.getElementById('meetingSlotsList').innerHTML = `
                        <div style="color: red; text-align: center;">
                            Error loading meeting slots: ${error.message || error.toString()}
                        </div>
                    `;
                })
                .getMeetingSlots();
        }
        
        function displayMeetingSlots() {
            const slotsList = document.getElementById('meetingSlotsList');
            
            if (currentMeetingSlots.length === 0) {
                slotsList.innerHTML = `
                    <div style="color: #666; text-align: center; font-style: italic; padding: 20px; border: 1px dashed #ccc; border-radius: 4px;">
                        No meeting slots configured. Add your first slot below.
                    </div>
                `;
            } else {
                let html = `
                    <div style="margin-bottom: 15px; font-weight: bold; color: #333;">
                        Configured Meeting Slots (${currentMeetingSlots.length}):
                    </div>
                `;
                
                currentMeetingSlots.forEach((slot, index) => {
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px; background-color: #fafafa;">
                            <div>
                                <strong>Day:</strong> ${escapeHtml(slot.dayOfWeek)}
                            </div>
                            <div>
                                <strong>Time:</strong> ${escapeHtml(slot.time)}
                            </div>
                            <div>
                                <strong>Duration:</strong> ${escapeHtml(slot.duration)} mins
                            </div>
                            <div>
                                <button onclick="editMeetingSlot(${index})" style="background: #ffc107; color: #000; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Edit</button>
                            </div>
                            <div>
                                <button onclick="deleteMeetingSlot(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                slotsList.innerHTML = html;
            }
        }
        
        function addMeetingSlot() {
            const day = document.getElementById('newSlotDay').value;
            const time = document.getElementById('newSlotTime').value;
            const duration = document.getElementById('newSlotDuration').value;
            
            if (!day || !time || !duration) {
                alert('Please fill in all fields for the meeting slot.');
                return;
            }
            
            if (parseInt(duration) < 15 || parseInt(duration) > 480) {
                alert('Duration must be between 15 and 480 minutes.');
                return;
            }
            
            const newSlot = {
                dayOfWeek: day,
                time: time,
                duration: duration
            };
            
            currentMeetingSlots.push(newSlot);
            markUnsavedChanges();
            displayMeetingSlots();
            
            // Clear form
            document.getElementById('newSlotTime').value = '';
            document.getElementById('newSlotDuration').value = '';
        }
        
        function editMeetingSlot(index) {
            const slot = currentMeetingSlots[index];
            if (!slot) return;
            
            const newDay = prompt('Day of Week:', slot.dayOfWeek);
            if (newDay === null) return; // User cancelled
            
            const newTime = prompt('Time (HH:MM format):', slot.time);
            if (newTime === null) return; // User cancelled
            
            const newDuration = prompt('Duration (minutes):', slot.duration);
            if (newDuration === null) return; // User cancelled
            
            // Validate inputs
            if (!newDay || !newTime || !newDuration) {
                alert('All fields are required.');
                return;
            }
            
            if (parseInt(newDuration) < 15 || parseInt(newDuration) > 480) {
                alert('Duration must be between 15 and 480 minutes.');
                return;
            }
            
            // Update the slot
            currentMeetingSlots[index] = {
                dayOfWeek: newDay,
                time: newTime,
                duration: newDuration
            };
            
            markUnsavedChanges();
            displayMeetingSlots();
        }
        
        function deleteMeetingSlot(index) {
            const slot = currentMeetingSlots[index];
            if (!slot) return;
            
            if (confirm(`Delete meeting slot: ${slot.dayOfWeek} at ${slot.time} for ${slot.duration} minutes?`)) {
                currentMeetingSlots.splice(index, 1);
                markUnsavedChanges();
                displayMeetingSlots();
            }
        }
        
        function saveConfiguration() {
            console.log('Saving configuration');
            
            // Check for unsaved changes and show warning
            if (checkForUnsavedChanges()) {
                const confirmSave = confirm('You have unsaved changes to your meeting slots. Are you sure you want to save these changes?');
                if (!confirmSave) {
                    return; // User cancelled the save
                }
            }
            
            // Show loading state
            const saveButton = document.querySelector('button[onclick="saveConfiguration()"]');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            // Save meeting slots
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Configuration saved successfully:', result);
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                    clearUnsavedChanges(); // Clear the unsaved changes flag
                    alert('Configuration saved successfully!');
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving configuration:', error);
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                    alert('Error saving configuration: ' + (error.message || error.toString()));
                })
                .saveMeetingSlots(currentMeetingSlots);
        }
        
        
        
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked tab
            const clickedTab = event.target;
            clickedTab.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'properties') {
                loadCurrentProperties();
            }
        }
        
        function loadCurrentProperties() {
            console.log('Loading current properties');
            
            const recurringIntervalInput = document.getElementById('recurringIntervalInput');
            
            // Load the recurring interval property
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Properties loaded:', result);
                    
                    // Update the input field with current value
                    recurringIntervalInput.value = result.value || 8;
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading properties:', error);
                    // Set default value in input on error
                    recurringIntervalInput.value = 8;
                })
                .getProperty('Recurring Interval');
        }
        
        function validateRecurringInterval() {
            const input = document.getElementById('recurringIntervalInput');
            const statusElement = document.getElementById('recurringIntervalStatus');
            const value = parseInt(input.value);
            
            if (isNaN(value) || value < 1 || value > 26) {
                statusElement.innerHTML = '<span style="color: #dc3545; font-size: 12px;">‚ö†Ô∏è Must be 1-26</span>';
                statusElement.style.display = 'block';
                return false;
            } else {
                statusElement.innerHTML = '<span style="color: #28a745; font-size: 12px;">‚úì Valid</span>';
                statusElement.style.display = 'block';
                return true;
            }
        }
        
        function saveRecurringInterval() {
            console.log('Saving recurring interval');
            
            const input = document.getElementById('recurringIntervalInput');
            const saveButton = document.getElementById('savePropertiesBtn');
            const statusElement = document.getElementById('propertiesStatus');
            
            // Get the value, default to 8 if empty or invalid
            let value = parseInt(input.value);
            if (isNaN(value) || input.value === '') {
                value = 8;
                input.value = 8; // Set the input to show the default
            }
            
            // Validate input
            if (!validateRecurringInterval()) {
                statusElement.innerHTML = `
                    <div style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                        <strong>Validation Error:</strong> Recurring interval must be between 1 and 26 weeks.
                    </div>
                `;
                statusElement.style.display = 'block';
                return;
            }
            
            // Show saving state
            const originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = `
                <div style="display: inline-flex; align-items: center; gap: 8px;">
                    <div style="border: 2px solid #f3f3f3; border-top: 2px solid #28a745; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>
                    Saving...
                </div>
            `;
            saveButton.disabled = true;
            
            statusElement.innerHTML = `
                <div style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;">
                    Saving recurring interval...
                </div>
            `;
            statusElement.style.display = 'block';
            
            // Save the property
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Recurring interval saved:', result);
                    
                    // Restore button
                    saveButton.innerHTML = originalButtonText;
                    saveButton.disabled = false;
                    
                    // Show success message
                    statusElement.innerHTML = `
                        <div style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;">
                            <strong>Success!</strong> ${result.message}
                        </div>
                    `;
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 3000);
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving recurring interval:', error);
                    
                    // Restore button
                    saveButton.innerHTML = originalButtonText;
                    saveButton.disabled = false;
                    
                    // Show error message
                    statusElement.innerHTML = `
                        <div style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                            <strong>Error:</strong> ${error.message || error.toString()}
                        </div>
                    `;
                })
                .setRecurringInterval(value);
        }
        
        function goBackToMenu() {
            console.log('Going back to main menu');
            const container = document.querySelector('.container');
            container.style.maxWidth = '400px'; // Reset to original width
            container.innerHTML = `
                <h1>Andy's Calendar Utilities</h1>
                
                <button class="button" onclick="handleNames()">
                    Skip Levels
                </button>
            `;
        }
        
        function onFailure(error) {
            console.error('Error:', error);
            alert('An error occurred: ' + error.message);
        }
    </script>
</body>
</html>
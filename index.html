<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta http-equiv="Permissions-Policy" content="ambient-light-sensor=(), speaker=(), vibrate=(), vr=()">
    <title>Andy's Calendar Utilities</title>
    <style>
        /* Professional Theme Design System */
        :root {
            /* Primary Colors */
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            
            /* Secondary Colors */
            --secondary-500: #6b7280;
            --secondary-600: #4b5563;
            --secondary-700: #374151;
            
            /* Success Colors */
            --success-500: #10b981;
            --success-600: #059669;
            --success-700: #047857;
            
            /* Warning Colors */
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            
            /* Danger Colors */
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            
            /* Neutral Colors */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            
            /* Typography */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Base Styles */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-sans);
            font-weight: var(--font-weight-normal);
            line-height: 1.6;
            color: var(--gray-800);
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--bg-secondary) 100%);
            margin: 0;
            padding: var(--space-lg);
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-primary);
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
        }
        
        /* Typography */
        h1 {
            font-size: 1.875rem;
            font-weight: var(--font-weight-bold);
            text-align: center;
            color: var(--gray-900);
            margin: 0 0 var(--space-2xl) 0;
            letter-spacing: -0.025em;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: var(--font-weight-semibold);
            color: var(--gray-800);
            margin: 0 0 var(--space-lg) 0;
            letter-spacing: -0.025em;
        }
        
        h3 {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
            color: var(--gray-700);
            margin: 0 0 var(--space-md) 0;
        }
        
        h4 {
            font-size: 1.125rem;
            font-weight: var(--font-weight-medium);
            color: var(--gray-700);
            margin: 0 0 var(--space-md) 0;
        }
        
        p {
            color: var(--gray-600);
            margin: 0 0 var(--space-md) 0;
        }
        
        /* Button System */
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-xl);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            line-height: 1.25;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            user-select: none;
        }
        
        .button:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Primary Button */
        .button {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            color: white;
        }
        
        .button:hover {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-800) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        /* Secondary Button */
        .button.secondary {
            background: var(--bg-primary);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        .button.secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }
        
        /* Success Button */
        .button.success {
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
            color: white;
        }
        
        .button.success:hover {
            background: linear-gradient(135deg, var(--success-600) 0%, var(--success-700) 100%);
        }
        
        /* Warning Button */
        .button.warning {
            background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
            color: white;
        }
        
        .button.warning:hover {
            background: linear-gradient(135deg, var(--warning-600) 0%, #b45309 100%);
        }
        
        /* Danger Button */
        .button.danger {
            background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-600) 100%);
            color: white;
        }
        
        .button.danger:hover {
            background: linear-gradient(135deg, var(--danger-600) 0%, #b91c1c 100%);
        }
        
        /* Full width button */
        .button.full {
            width: 100%;
            margin: var(--space-md) 0;
        }
        /* Loading Components */
        .spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-600);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s linear infinite;
            margin: var(--space-md) auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-container {
            text-align: center;
            color: var(--gray-500);
            padding: var(--space-xl);
        }
        
        .loading-container p {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: var(--space-sm);
        }
        /* Tab System */
        .tab-container {
            display: flex;
            background: var(--gray-100);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            margin-bottom: 0;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            border-bottom: none;
        }
        
        .tab {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            color: var(--gray-600);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-bottom: 2px solid transparent;
            text-transform: none;
            letter-spacing: 0.025em;
            line-height: 1.4;
        }
        
        .tab:not(:last-child) {
            border-right: 1px solid var(--gray-200);
        }
        
        .tab:hover {
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
            color: var(--gray-700);
            transform: translateY(-1px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--gray-50) 100%);
            color: var(--primary-700);
            border-bottom: 2px solid var(--primary-600);
            transform: translateY(-1px);
            font-weight: var(--font-weight-semibold);
        }
        
        .tab-content {
            display: none;
            background: var(--bg-primary);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            border-top: none;
            padding: 0;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(8px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        /* Dropdown Components */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .actions-btn {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .actions-btn:hover {
            background: linear-gradient(135deg, var(--secondary-600) 0%, var(--secondary-700) 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: var(--space-xs);
            background: var(--bg-primary);
            min-width: 12rem;
            white-space: nowrap;
            box-shadow: var(--shadow-xl);
            border-radius: var(--radius-md);
            z-index: 1000;
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }
        
        .dropdown-content.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        
        @keyframes dropdownFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-8px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .dropdown-item {
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: var(--font-weight-normal);
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-100);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }
        
        .dropdown-item.remove {
            color: var(--danger-600);
        }
        
        .dropdown-item.remove:hover {
            background: #fef2f2;
            color: var(--danger-700);
        }
        
        .dropdown-item.add {
            color: var(--success-600);
        }
        
        .dropdown-item.add:hover {
            background: #f0fdf4;
            color: var(--success-700);
        }
        
        /* Form Components */
        .form-section {
            background: var(--bg-secondary);
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--space-lg);
        }
        
        .form-grid {
            display: grid;
            gap: var(--space-md);
            align-items: end;
        }
        
        .form-grid.cols-2 {
            grid-template-columns: 1fr auto;
        }
        
        .form-grid.cols-3 {
            grid-template-columns: 1fr 1fr auto;
        }
        
        .form-grid.cols-4 {
            grid-template-columns: 1fr 1fr 1fr auto;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label, label {
            display: block;
            margin-bottom: var(--space-sm);
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--gray-700);
        }
        
        .form-input, input[type="text"], input[type="number"], input[type="time"], input[type="file"], select {
            width: 100%;
            padding: var(--space-md);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            color: var(--gray-900);
            background: var(--bg-primary);
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-input:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-input::placeholder, input::placeholder {
            color: var(--gray-400);
        }
        
        /* Card Components */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-sm);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
            color: var(--gray-800);
            margin: 0;
        }
        
        .section-description {
            color: var(--gray-600);
            font-size: 0.875rem;
            margin: var(--space-sm) 0 var(--space-lg) 0;
        }
        
        /* Custom Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: var(--gray-900);
            color: var(--bg-primary);
            text-align: center;
            border-radius: var(--radius-md);
            padding: var(--space-md);
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-700);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--gray-900) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Enhanced Actions Button and Dropdown Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
            z-index: 1000;
        }
        
        .actions-btn {
            background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            min-width: 80px;
            justify-content: center;
        }
        
        .actions-btn:hover {
            background: linear-gradient(135deg, var(--secondary-600) 0%, var(--secondary-700) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 9999;
            right: 0;
            top: calc(100% + 4px);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }
        
        .dropdown-content.show {
            display: block !important;
            animation: dropdownFadeIn 0.2s ease;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: var(--gray-50);
        }
        
        .dropdown-item.add {
            color: var(--success-600);
        }
        
        .dropdown-item.add:hover {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .dropdown-item.remove {
            color: var(--danger-500);
        }
        
        .dropdown-item.remove:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .dropdown-item.remove-meeting {
            color: var(--warning-600);
        }
        
        .dropdown-item.remove-meeting:hover {
            background-color: rgba(245, 158, 11, 0.1);
        }
        
        /* Enhanced People List Row Hover Effect */
        .people-list-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12) !important;
        }
        
        /* Ensure parent containers don't clip dropdowns */
        .tab-content, .form-section {
            overflow: visible !important;
        }
        
        /* Specific override for People list container */
        #currentNamesContent {
            overflow: visible !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Andy's Calendar Utilities</h1>
        
        <button class="button full" onclick="handleNames()">
            Skip Levels
        </button>
        
        
    </div>

    <script>
        // Test that JavaScript is working
        console.log('JavaScript loaded successfully');
        
        // Test page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded successfully');
        });
        
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTimeHHMM(timeString) {
            if (!timeString) return '';
            
            try {
                // Handle different time formats
                if (timeString.includes(':')) {
                    // If it's already in HH:MM format or HH:MM:SS format
                    const timeParts = timeString.split(':');
                    if (timeParts.length >= 2) {
                        const hours = timeParts[0].padStart(2, '0');
                        const minutes = timeParts[1].padStart(2, '0');
                        return `${hours}:${minutes}`;
                    }
                }
                
                // Try to parse as Date if it's a full datetime string
                const date = new Date(timeString);
                if (!isNaN(date.getTime())) {
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    return `${hours}:${minutes}`;
                }
                
                // If all else fails, return the original string
                return escapeHtml(timeString);
            } catch (error) {
                console.warn('Error formatting time:', timeString, error);
                return escapeHtml(timeString);
            }
        }

        // Enhanced cache for Skip Levels list with timestamp
        let cachedNamesWithEvents = null;
        let cacheTimestamp = null;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
        
        function isCacheValid() {
            return cachedNamesWithEvents && cacheTimestamp && 
                   (Date.now() - cacheTimestamp) < CACHE_DURATION;
        }

        function handleNames() {
            console.log('Names button clicked');
            
            // Check if google.script.run is available
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                alert('Error: Google Apps Script not available. Make sure this is running as a deployed web app.');
                console.error('google.script.run not available');
                return;
            }
            
            // Show names management screen
            const container = document.querySelector('.container');
            container.style.maxWidth = '800px';
            container.innerHTML = `
                <div class="card-header">
                    <h1>Skip Levels</h1>
                    <button class="button secondary" onclick="goBackToMenu()">
                        Back to Menu
                    </button>
                </div>
                
                <!-- Tab Navigation -->
                <div class="tab-container">
                    <button class="tab active" onclick="showTab('currentNames')">People</button>
                    <button class="tab" onclick="showTab('uploadFile')">Upload Names from File</button>
                    <button class="tab" onclick="showTab('meetingSlots')">Meeting Slots</button>
                    <button class="tab" onclick="showTab('properties')">Properties</button>
                </div>
                
                <!-- Current Names Tab -->
                <div id="currentNamesTab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="section-title">People</h2>
                            <div class="actions-dropdown">
                                <button class="actions-btn" onclick="toggleActionsDropdown()">
                                    Mass Actions
                                    <span style="font-size: 0.625rem;">▼</span>
                                </button>
                                <div id="actionsDropdown" class="dropdown-content">
                                    <div class="dropdown-item" onclick="refreshCurrentNames(); closeActionsDropdown();">
                                        <span>🔄</span> Refresh
                                    </div>
                                    <div class="dropdown-item add" onclick="addAllMeetings(); closeActionsDropdown();">
                                        <span>➕</span> Add Missing Meetings
                                    </div>
                                    <div class="dropdown-item remove" onclick="deleteAllMeetings(); closeActionsDropdown();">
                                        <span>🗑️</span> Delete All
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="namesList" class="form-section" style="min-height: 3.5rem;">
                            <div class="loading-container">
                                <div class="spinner"></div>
                                <p>Loading current names...</p>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>Add Individual Name:</h4>
                            <div class="form-grid cols-2">
                                <div class="form-group">
                                    <label class="form-label">Name:</label>
                                    <input type="text" id="newNameInput" class="form-input" placeholder="Enter name to add" onkeypress="if(event.key==='Enter') addIndividualName()">
                                </div>
                                <div>
                                    <button class="button success" onclick="addIndividualName()">Add Name</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Names from File Tab -->
                <div id="uploadFileTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="section-title">Upload Names from File</h2>
                        </div>
                        
                        <div class="form-section" style="border: 2px dashed var(--gray-300); text-align: center;">
                            <p class="section-description" style="text-align: center;">
                                Upload a text file containing names (one name per line)
                            </p>
                            <div class="form-grid cols-2">
                                <input type="file" id="nameFileInput" accept=".txt,.text" class="form-input">
                                <button class="button" onclick="processNameFile()">
                                    Upload and Process File
                                </button>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="button danger" onclick="clearAllNames()">
                                Clear All Names
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Meeting Slots Tab -->
                <div id="meetingSlotsTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="section-title">Meeting Slots Configuration</h2>
                        </div>
                        <p class="section-description">
                            Configure recurring meeting time slots for skip level meetings
                        </p>
                        
                        <div id="meetingSlotsList" class="form-section">
                            <div class="loading-container">
                                <div class="spinner"></div>
                                <p>Loading meeting slots...</p>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>Add New Meeting Slot:</h4>
                            <div class="form-grid cols-4">
                                <div class="form-group">
                                    <label class="form-label">Day of Week:</label>
                                    <select id="newSlotDay" class="form-input">
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Time:</label>
                                    <input type="time" id="newSlotTime" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration (mins):</label>
                                    <input type="number" id="newSlotDuration" class="form-input" placeholder="30" min="15" max="480">
                                </div>
                                <div>
                                    <button class="button" onclick="addMeetingSlot()">Add</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="button success" onclick="saveConfiguration()">
                                Save Configuration
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Properties Tab -->
                <div id="propertiesTab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="section-title">Application Properties</h2>
                        </div>
                        <p class="section-description">
                            Configure application settings and properties
                        </p>
                        
                        <div class="form-section">
                            <div class="form-group">
                                <label class="form-label" style="font-size: 1rem;">Recurring Interval (weeks):</label>
                                <p class="section-description" style="margin-bottom: var(--space-md);">
                                    Number of weeks between recurring skip level meetings (1-26)
                                </p>
                                <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-lg);">
                                    <input type="number" id="recurringIntervalInput" min="1" max="26" placeholder="Loading..." 
                                           class="form-input" style="width: 5rem; text-align: center;"
                                           onchange="validateRecurringInterval()">
                                    <span style="color: var(--gray-600); font-size: 0.875rem;">weeks</span>
                                    <div id="recurringIntervalStatus"></div>
                                </div>
                                <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
                                    <div class="tooltip">
                                        <button id="autoCalculateBtn" class="button secondary" onclick="autoCalculateRecurringInterval()">
                                            🧮 Auto Calculate
                                        </button>
                                        <span class="tooltiptext">The number of names divided by the number of meeting slots rounded to the nearest whole integer</span>
                                    </div>
                                    <button id="savePropertiesBtn" class="button success" onclick="saveRecurringInterval()">
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="propertiesStatus" class="form-section" style="display: none;">
                        </div>
                    </div>
                </div>
            `;
            
            // Check if we have valid cached data to avoid redundant searches
            if (isCacheValid()) {
                console.log('Using cached names data (valid for ' + Math.round((CACHE_DURATION - (Date.now() - cacheTimestamp)) / 1000) + ' more seconds)');
                displayCurrentNames(cachedNamesWithEvents);
            } else {
                console.log('Loading names - cache expired or missing');
                loadCurrentNames();
            }
            
            // Load meeting slots data for the Meeting Slots tab
            loadMeetingSlots();
        }
        
        
        
        function processNameFile() {
            console.log('Processing name file');
            const fileInput = document.getElementById('nameFileInput');
            const file = fileInput.files[0];
            const uploadButton = document.querySelector('button[onclick="processNameFile()"]');
            
            if (!file) {
                alert('Please select a file first.');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.txt') && !file.name.toLowerCase().endsWith('.text')) {
                alert('Please select a text file (.txt or .text).');
                return;
            }
            
            // Show spinner on button and disable it
            const originalButtonText = uploadButton.innerHTML;
            uploadButton.innerHTML = '<div style="display: inline-flex; align-items: center; gap: 8px;"><div style="border: 2px solid #f3f3f3; border-top: 2px solid #4285f4; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>Processing...</div>';
            uploadButton.disabled = true;
            uploadButton.style.opacity = '0.7';
            uploadButton.style.cursor = 'not-allowed';
            
            const reader = new FileReader();
            // Helper function to restore button state
            function restoreButtonState() {
                uploadButton.innerHTML = originalButtonText;
                uploadButton.disabled = false;
                uploadButton.style.opacity = '1';
                uploadButton.style.cursor = 'pointer';
            }
            
            reader.onload = function(e) {
                const content = e.target.result;
                const names = content.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
                
                if (names.length === 0) {
                    restoreButtonState();
                    alert('No valid names found in the file.');
                    return;
                }
                
                console.log('Parsed names:', names);
                
                // Check for duplicates within the file
                const uniqueNames = [];
                const duplicatesInFile = [];
                const seenNames = new Set();
                
                names.forEach(name => {
                    const lowerName = name.toLowerCase();
                    if (seenNames.has(lowerName)) {
                        duplicatesInFile.push(name);
                    } else {
                        seenNames.add(lowerName);
                        uniqueNames.push(name);
                    }
                });
                
                if (duplicatesInFile.length > 0) {
                    restoreButtonState();
                    alert(`Error: The file contains duplicate names:\n${duplicatesInFile.join(', ')}\n\nPlease remove duplicates and try again.`);
                    return;
                }
                
                // Show loading state
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Saving ${uniqueNames.length} names and searching calendar events...</p>
                        <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                            This may take a moment while we search for existing calendar events
                        </div>
                    </div>
                `;
                
                // Get current names to check for duplicates
                google.script.run
                    .withSuccessHandler(function(currentNames) {
                        const duplicatesWithExisting = [];
                        const newNames = [];
                        
                        uniqueNames.forEach(name => {
                            if (currentNames.some(existing => existing.toLowerCase() === name.toLowerCase())) {
                                duplicatesWithExisting.push(name);
                            } else {
                                newNames.push(name);
                            }
                        });
                        
                        if (duplicatesWithExisting.length > 0) {
                            restoreButtonState();
                            loadCurrentNames();
                            alert(`Error: The following names already exist in the list:\n${duplicatesWithExisting.join(', ')}\n\nDuplicate names cannot be added.`);
                            return;
                        }
                        
                        if (newNames.length === 0) {
                            restoreButtonState();
                            loadCurrentNames();
                            alert('No new names to add - all names in the file already exist.');
                            return;
                        }
                        
                        // Combine existing names with new names
                        const allNames = [...currentNames, ...newNames];
                        
                        // Save the new names with calendar search
                        google.script.run
                            .withSuccessHandler(function(result) {
                                console.log('Names with calendar data saved successfully:', result);
                                restoreButtonState();
                                cachedNamesWithEvents = null; // Clear cache to force reload
                                loadCurrentNames();
                                alert(`Successfully added ${newNames.length} new names with calendar event search!`);
                            })
                            .withFailureHandler(function(error) {
                                console.error('Error saving names with calendar data:', error);
                                restoreButtonState();
                                alert('Error saving names with calendar data: ' + (error.message || error.toString()));
                                loadCurrentNames();
                            })
                            .saveSkipLevelNames(allNames);
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error getting current names:', error);
                        restoreButtonState();
                        alert('Error checking for duplicates: ' + (error.message || error.toString()));
                        loadCurrentNames();
                    })
                    .getSkipLevelNames();
            };
            
            reader.onerror = function() {
                restoreButtonState();
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsText(file);
        }
        
        function loadCurrentNames() {
            console.log('Loading current names with calendar events');
            
            // Show loading spinner while waiting for complete calendar search
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Searching calendar for Skip Level meetings...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        Please wait while we check your calendar events
                    </div>
                </div>
            `;
            
            // Load names with complete calendar data before displaying
            google.script.run
                .withSuccessHandler(function(namesWithEvents) {
                    console.log('Complete calendar data loaded:', namesWithEvents);
                    
                    if (!namesWithEvents || namesWithEvents.length === 0) {
                        document.getElementById('namesList').innerHTML = `
                            <div style="color: #666; text-align: center; font-style: italic;">
                                No names currently loaded. Upload a text file to get started.
                            </div>
                        `;
                        cachedNamesWithEvents = [];
                        cacheTimestamp = Date.now();
                        return;
                    }
                    
                    // Display complete results with calendar data
                    cachedNamesWithEvents = namesWithEvents;
                    cacheTimestamp = Date.now();
                    displayCurrentNames(namesWithEvents);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading names with calendar events:', error);
                    document.getElementById('namesList').innerHTML = `
                        <div style="color: red; text-align: center;">
                            Error loading names: ${error.message || error.toString()}
                        </div>
                    `;
                })
                .getNamesWithCalendarEvents();
        }
        
        function toggleActionsDropdown() {
            const dropdown = document.getElementById('actionsDropdown');
            const allDropdowns = document.querySelectorAll('.dropdown-content');
            
            // Close all other dropdowns first
            allDropdowns.forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                }
            });
            
            // Toggle this dropdown
            dropdown.classList.toggle('show');
        }
        
        function closeActionsDropdown() {
            const dropdown = document.getElementById('actionsDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }
        
        function refreshCurrentNames() {
            console.log('Refreshing current names with calendar events');
            cachedNamesWithEvents = null; // Clear cache to force reload
            cacheTimestamp = null; // Clear cache timestamp
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Refreshing names with calendar data...</p>
                </div>
            `;
            
            loadCurrentNames();
        }
        
        function addAllMeetings() {
            console.log('Add all meetings requested');
            
            if (!cachedNamesWithEvents || cachedNamesWithEvents.length === 0) {
                alert('No names loaded. Please refresh the list first.');
                return;
            }
            
            // Only include names that don't have calendar meeting links (found: false)
            const namesWithoutMeetings = cachedNamesWithEvents.filter(nameData => !nameData.found);
            
            if (namesWithoutMeetings.length === 0) {
                alert('All names already have recurring meetings. No new meetings to create.');
                return;
            }
            
            // Extract just the names for the backend
            const namesToProcess = namesWithoutMeetings.map(nameData => nameData.name);
            
            console.log('Names without meetings to process:', namesToProcess);
            
            // Show detailed confirmation
            const confirmMessage = `Create recurring meetings for names without calendar links?\n\n` +
                                 `Names that will get new meetings: ${namesWithoutMeetings.length}\n` +
                                 `• ${namesWithoutMeetings.map(n => n.name).join('\\n• ')}\n\n` +
                                 `This will:\n` +
                                 `• Search for available meeting slots across the next several weeks\n` +
                                 `• Create recurring Skip Level meetings for each name\n` +
                                 `• Schedule meetings based on your configured meeting slots\n\n` +
                                 `Continue with bulk meeting creation?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Creating recurring meetings for ${namesWithoutMeetings.length} names...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        This may take a moment as we search for available slots...
                    </div>
                </div>
            `;
            
            // Call backend with the specific names to process
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('All meetings created successfully:', result);
                    
                    // Clear cache and refresh the list
                    cachedNamesWithEvents = null;
                    cacheTimestamp = null;
                    
                    // Show success message
                    let successMessage = `✓ Bulk meeting creation completed!\n\n`;
                    successMessage += `Summary:\n`;
                    successMessage += `• Names processed: ${result.namesProcessed}\n`;
                    successMessage += `• Meetings created: ${result.meetingsCreated}\n`;
                    successMessage += `• Names with no available slots: ${result.namesWithoutSlots}\n`;
                    successMessage += `• Weeks calculated for recurrence: ${result.weeksCalculated}`;
                    
                    if (result.errors && result.errors.length > 0) {
                        successMessage += `\n\nWarnings:\n`;
                        successMessage += `• ${result.errors.join('\\n• ')}`;
                    }
                    
                    alert(successMessage);
                    
                    // Refresh the names list to show updated status
                    loadCurrentNames();
                })
                .withFailureHandler(function(error) {
                    console.error('Error creating all meetings:', error);
                    alert('Error creating meetings: ' + (error.message || error.toString()));
                    
                    // Refresh the names list anyway
                    loadCurrentNames();
                })
                .createMeetingsForSpecificNames(namesToProcess);
        }
        
        function deleteAllMeetings() {
            console.log('Delete all requested - clearing names list and calendar events');
            
            if (!cachedNamesWithEvents || cachedNamesWithEvents.length === 0) {
                alert('No names loaded. Please refresh the list first.');
                return;
            }
            
            const totalNames = cachedNamesWithEvents.length;
            const namesWithMeetings = cachedNamesWithEvents.filter(nameData => nameData.found);
            
            // Show detailed confirmation
            const confirmMessage = `⚠️ CRITICAL WARNING ⚠️\n\n` +
                                 `This action will:\n` +
                                 `• DELETE ALL ${totalNames} names from the list\n` +
                                 `• DELETE ALL recurring Skip Level calendar events\n\n` +
                                 `Names to be removed: ${totalNames}\n` +
                                 `• ${cachedNamesWithEvents.map(n => n.name).join('\\n• ')}\n\n` +
                                 `Calendar events to be deleted: ${namesWithMeetings.length} recurring series\n\n` +
                                 `THIS WILL COMPLETELY CLEAR EVERYTHING AND CANNOT BE UNDONE!\n\n` +
                                 `Are you absolutely certain you want to proceed?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Final confirmation
            if (!confirm(`FINAL CONFIRMATION:\n\nClear ALL names and delete ALL calendar events?\n\nThis is your LAST CHANCE to cancel!`)) {
                return;
            }
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Clearing all names and deleting calendar events...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        This may take a moment. Please wait...
                    </div>
                </div>
            `;
            
            // First delete all meetings, then clear names
            google.script.run
                .withSuccessHandler(function(deleteResult) {
                    console.log('All meetings deleted successfully:', deleteResult);
                    
                    // Now clear all names
                    google.script.run
                        .withSuccessHandler(function(clearResult) {
                            console.log('All names cleared successfully:', clearResult);
                            
                            // Clear cache and refresh the list
                            cachedNamesWithEvents = null;
                            cacheTimestamp = null;
                            
                            // Show success message
                            let successMessage = `✓ Successfully cleared everything!\n\n`;
                            successMessage += `Summary:\n`;
                            successMessage += `• Names cleared: ${totalNames}\n`;
                            successMessage += `• Calendar events deleted: ${deleteResult.meetingsDeleted}\n`;
                            
                            if (deleteResult.errors && deleteResult.errors.length > 0) {
                                successMessage += `\n\nWarnings:\n`;
                                successMessage += `• ${deleteResult.errors.join('\\n• ')}`;
                            }
                            
                            alert(successMessage);
                            
                            // Refresh the names list to show updated status
                            loadCurrentNames();
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error clearing names:', error);
                            alert('Error clearing names: ' + (error.message || error.toString()));
                            loadCurrentNames();
                        })
                        .clearSkipLevelNames();
                })
                .withFailureHandler(function(error) {
                    console.error('Error deleting calendar events:', error);
                    alert('Error deleting calendar events: ' + (error.message || error.toString()));
                    loadCurrentNames();
                })
                .deleteAllRecurringMeetings();
        }
        
        function displayCurrentNames(namesWithEvents) {
            console.log('displayCurrentNames called with:', namesWithEvents);
            const namesList = document.getElementById('namesList');
            
            if (!namesWithEvents || namesWithEvents.length === 0) {
                namesList.innerHTML = `
                    <div style="color: #666; text-align: center; font-style: italic;">
                        No names currently loaded. Upload a text file to get started.
                    </div>
                `;
            } else {
                console.log('Processing', namesWithEvents.length, 'names for display');
                // Sort names alphabetically by name property
                let sortedNamesWithEvents;
                try {
                    sortedNamesWithEvents = [...namesWithEvents].sort((a, b) => {
                        if (!a.name || !b.name) {
                            console.warn('Name data missing:', a, b);
                            return 0;
                        }
                        return a.name.localeCompare(b.name);
                    });
                } catch (error) {
                    console.error('Error sorting names:', error);
                    sortedNamesWithEvents = [...namesWithEvents];
                }
                
                let html = `
                    <div style="margin-bottom: 15px; font-weight: bold; color: #333;">
                        ${namesWithEvents.length} name(s) loaded (sorted alphabetically):
                    </div>
                `;
                
                sortedNamesWithEvents.forEach((nameData, index) => {
                    try {
                        console.log('Processing name data:', nameData);
                        if (!nameData || !nameData.name) {
                            console.warn('Invalid name data at index', index, ':', nameData);
                            return;
                        }
                        
                        const backgroundColor = index % 2 === 0 ? '#fbfcfd' : '#ffffff';
                        const borderColor = nameData.found ? '#d4edda' : '#f8d7da';
                        const leftBorderColor = nameData.found ? '#28a745' : '#dc3545';
                    
                    // Determine calendar status display
                    let calendarStatus = '';
                    let statusIcon = '';
                    if (nameData.found && nameData.nextOccurrence) {
                        statusIcon = '<span style="color: #28a745; font-size: 14px; margin-right: 8px;">✓</span>';
                        // Remove any bracketed timezone information from display
                        const cleanNextOccurrence = nameData.nextOccurrence.replace(/\s*\([^)]*\)/g, '');
                        calendarStatus = `<a href="${nameData.calendarLink}" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: 500;">📅 ${cleanNextOccurrence}</a>`;
                    } else {
                        statusIcon = '<span style="color: #dc3545; font-size: 14px; margin-right: 8px;">✗</span>';
                        calendarStatus = '<span style="color: #6c757d; font-style: italic;">No meeting scheduled</span>';
                    }
                    
                    html += `
                        <div class="people-list-row" style="border: 1px solid ${borderColor}; border-left: 4px solid ${leftBorderColor}; border-radius: 8px; padding: 16px 20px; margin-bottom: 10px; background-color: ${backgroundColor}; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 20px; align-items: center; min-height: 24px;">
                                <!-- Name on the left -->
                                <div style="display: flex; align-items: center;">
                                    <span style="font-weight: 600; color: #2c3e50; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(nameData.name)}</span>
                                </div>
                                <!-- Status right-justified in middle -->
                                <div style="display: flex; align-items: center; justify-content: flex-end; white-space: nowrap; min-width: 200px;">
                                    ${statusIcon}
                                    <span style="font-size: 14px; white-space: nowrap; color: ${nameData.found ? '#28a745' : '#6c757d'};">${calendarStatus}</span>
                                </div>
                                <!-- Actions button on the right -->
                                <div style="flex-shrink: 0;">
                                    <div class="actions-dropdown">
                                        <button class="actions-btn" onclick="toggleDropdown('${escapeHtml(nameData.name).replace(/'/g, "\\'")}')">
                                            Actions
                                            <span style="font-size: 10px; margin-left: 4px;">▼</span>
                                        </button>
                                        <div id="dropdown-${escapeHtml(nameData.name).replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '')}" class="dropdown-content">
                                            ${!nameData.found ? 
                                                `<div class="dropdown-item add" onclick="addRecurringMeeting('${escapeHtml(nameData.name).replace(/'/g, "\\'")}')">
                                                    <span>➕</span> Add Recurring Meeting
                                                </div>` : 
                                                `<div class="dropdown-item remove-meeting" onclick="removeRecurringMeeting('${escapeHtml(nameData.name).replace(/'/g, "\\'")}')">
                                                    <span>📅❌</span> Remove Recurring Meeting
                                                </div>`
                                            }
                                            <div class="dropdown-item remove" onclick="removeIndividualName('${escapeHtml(nameData.name).replace(/'/g, "\\'")}')">
                                                <span>🗑️</span> Remove
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    } catch (error) {
                        console.error('Error processing name data at index', index, ':', error, nameData);
                    }
                });
                
                namesList.innerHTML = html;
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', function(event) {
                    if (!event.target.matches('.actions-btn')) {
                        const dropdowns = document.querySelectorAll('.dropdown-content');
                        dropdowns.forEach(dropdown => {
                            dropdown.classList.remove('show');
                        });
                    }
                });
            }
        }
        
        function toggleDropdown(name) {
            console.log('toggleDropdown called for name:', name);
            
            // Close all other dropdowns first
            const allDropdowns = document.querySelectorAll('.dropdown-content');
            console.log('Found', allDropdowns.length, 'dropdowns total');
            allDropdowns.forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // Generate the same ID as used in the HTML
            const dropdownId = 'dropdown-' + name.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            console.log('Looking for dropdown with ID:', dropdownId);
            const dropdown = document.getElementById(dropdownId);
            
            if (dropdown) {
                console.log('Dropdown found, toggling show class');
                dropdown.classList.toggle('show');
                console.log('Dropdown now has classes:', dropdown.className);
                
                // Add click outside to close functionality
                if (dropdown.classList.contains('show')) {
                    console.log('Dropdown is now showing, adding click outside handler');
                    setTimeout(() => {
                        document.addEventListener('click', function closeOnClickOutside(event) {
                            if (!dropdown.contains(event.target) && !event.target.closest('.actions-btn')) {
                                dropdown.classList.remove('show');
                                document.removeEventListener('click', closeOnClickOutside);
                            }
                        });
                    }, 10);
                }
            } else {
                console.error('Dropdown not found with ID:', dropdownId);
                console.log('Available dropdown IDs:', Array.from(document.querySelectorAll('.dropdown-content')).map(d => d.id));
            }
        }
        
        function addRecurringMeeting(name) {
            // Close the dropdown
            const dropdownId = 'dropdown-' + name.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            console.log('Adding recurring meeting for:', name);
            
            // Show confirmation dialog
            const confirmMessage = `Add a recurring meeting for "${name}"?\n\n` +
                                 `This will:\n` +
                                 `• Search for available meeting slots in your calendar\n` +
                                 `• Create a recurring Skip Level meeting\n` +
                                 `• Schedule meetings based on configured meeting slots\n\n` +
                                 `Continue?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Creating recurring meeting for "${name}"...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        Calculating schedule and checking calendar availability
                    </div>
                </div>
            `;
            
            // Call backend to create the recurring meeting
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Recurring meeting created successfully:', result);
                    
                    // Show success message
                    let successMessage = `✓ Recurring meeting created successfully for "${name}"!\n\n`;
                    
                    if (result.meetingCreated) {
                        successMessage += `Meeting Details:\n`;
                        successMessage += `• Day: ${result.meetingDetails.dayOfWeek}\n`;
                        successMessage += `• Time: ${result.meetingDetails.time}\n`;
                        successMessage += `• Duration: ${result.meetingDetails.duration} minutes\n`;
                        successMessage += `• Frequency: Every ${result.weeksCalculated} weeks\n`;
                        successMessage += `• Title: Skip Level: ${name}`;
                    } else {
                        successMessage += `No available slots found in the next ${result.weeksCalculated} weeks.\n`;
                        successMessage += `Please check your meeting slot configuration or calendar availability.`;
                    }
                    
                    alert(successMessage);
                    
                    // Return to current names list and refresh to show updated calendar status
                    cachedNamesWithEvents = null; // Clear cache to force calendar search
                    loadCurrentNames();
                })
                .withFailureHandler(function(error) {
                    console.error('Error creating recurring meeting:', error);
                    alert('Error creating recurring meeting: ' + (error.message || error.toString()));
                    
                    // Refresh the names list on error
                    loadCurrentNames();
                })
                .createRecurringMeeting(name);
        }
        
        function clearAllNames() {
            if (!confirm('Are you sure you want to clear all loaded names? This action cannot be undone.')) {
                return;
            }
            
            console.log('Clearing all names');
            
            // Get the clear button and show spinner
            const clearButton = document.querySelector('button[onclick="clearAllNames()"]');
            const originalButtonText = clearButton.innerHTML;
            
            // Show spinner on button and disable it
            clearButton.innerHTML = '<div style="display: inline-flex; align-items: center; gap: 8px;"><div style="border: 2px solid #f3f3f3; border-top: 2px solid #dc3545; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>Clearing...</div>';
            clearButton.disabled = true;
            clearButton.style.opacity = '0.7';
            clearButton.style.cursor = 'not-allowed';
            
            // Helper function to restore button state
            function restoreButtonState() {
                clearButton.innerHTML = originalButtonText;
                clearButton.disabled = false;
                clearButton.style.opacity = '1';
                clearButton.style.cursor = 'pointer';
            }
            
            // Show loading state in the names list as well
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Clearing all names...</p>
                </div>
            `;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Names cleared successfully');
                    restoreButtonState();
                    cachedNamesWithEvents = null; // Clear cache
                    loadCurrentNames();
                    alert('All names have been cleared.');
                })
                .withFailureHandler(function(error) {
                    console.error('Error clearing names:', error);
                    restoreButtonState();
                    alert('Error clearing names: ' + (error.message || error.toString()));
                    loadCurrentNames();
                })
                .clearSkipLevelNames();
        }
        
        function removeIndividualName(nameToRemove) {
            console.log('Removing individual name:', nameToRemove);
            
            // Use cached data if available, otherwise get fresh data
            if (!cachedNamesWithEvents || cachedNamesWithEvents.length === 0) {
                console.log('No cached data available, refreshing...');
                // Show loading and refresh data
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading current data...</p>
                    </div>
                `;
                loadCurrentNames();
                return;
            }
            
            const currentNamesWithEvents = [...cachedNamesWithEvents];
            const nameToRemoveData = currentNamesWithEvents.find(nameData => nameData.name === nameToRemove);
            const hasCalendarEvent = nameToRemoveData ? nameToRemoveData.found : false;
            
            // Show immediate warning message
            let confirmMessage = `⚠️ WARNING ⚠️\n\nThis action will remove "${nameToRemove}" from the names list.`;
            
            if (hasCalendarEvent) {
                // Name has calendar events - warn about calendar deletion
                confirmMessage = `⚠️ IMPORTANT WARNING ⚠️\n\n` +
                               `This action will:\n` +
                               `• Remove "${nameToRemove}" from the names list\n` +
                               `• DELETE all Skip Level calendar events for "${nameToRemove}"\n` +
                               `• DELETE all future occurrences of these meetings\n\n` +
                               `This action CANNOT be undone!\n\n` +
                               `Are you absolutely sure you want to proceed?`;
            } else {
                confirmMessage += `\n\nAre you sure you want to proceed?`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            if (hasCalendarEvent) {
                // Name has calendar events - use the full removeSkipLevel function
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Removing "${nameToRemove}" and calendar events...</p>
                    </div>
                `;
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Name and calendar events removed successfully:', result);
                        
                        // Custom success handler to refresh the list and show confirmation
                        google.script.run
                            .withSuccessHandler(function(updatedNamesWithEvents) {
                                console.log('Names list refreshed after removing');
                                displayCurrentNames(updatedNamesWithEvents);
                                
                                // Show detailed success message
                                let successMessage = `✓ "${nameToRemove}" has been successfully removed from the list.`;
                                if (result.deletedEventCount > 0) {
                                    successMessage += `\n\n${result.deletedEventCount} calendar event(s) were also deleted.`;
                                }
                                
                                setTimeout(() => {
                                    alert(successMessage);
                                }, 100);
                            })
                            .withFailureHandler(function(error) {
                                console.error('Error refreshing names list:', error);
                                alert('Name and calendar events were removed but there was an error refreshing the list: ' + (error.message || error.toString()));
                            })
                            .getNamesWithCalendarEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error removing name and calendar events:', error);
                        alert('Error removing name and calendar events: ' + (error.message || error.toString()));
                        loadCurrentNames();
                    })
                    .removeSkipLevel(nameToRemove);
            } else {
                // Name has no calendar events - remove from list and refresh data
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Removing "${nameToRemove}" from list...</p>
                    </div>
                `;
                
                // Remove the name from the local list
                const updatedNamesWithEvents = currentNamesWithEvents.filter(nameData => nameData.name !== nameToRemove);
                
                // Extract just the names for saving
                const updatedNames = updatedNamesWithEvents.map(nameData => nameData.name);
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Name removed successfully, refreshing calendar data for remaining names');
                        
                        // Instead of using cached data, refresh from Google Sheet to ensure accuracy
                        google.script.run
                            .withSuccessHandler(function(refreshedNamesWithEvents) {
                                console.log('Names list refreshed after removal with updated calendar data');
                                
                                // Update cache with fresh data
                                cachedNamesWithEvents = refreshedNamesWithEvents;
                                cacheTimestamp = Date.now();
                                
                                // Display the refreshed list
                                displayCurrentNames(refreshedNamesWithEvents);
                                
                                // Show success message
                                setTimeout(() => {
                                    alert(`✓ "${nameToRemove}" has been successfully removed from the list.`);
                                }, 100);
                            })
                            .withFailureHandler(function(error) {
                                console.error('Error refreshing names list after removal:', error);
                                
                                // Fallback to filtered cached data if refresh fails
                                cachedNamesWithEvents = updatedNamesWithEvents;
                                displayCurrentNames(updatedNamesWithEvents);
                                
                                alert(`"${nameToRemove}" was removed, but there was an error refreshing calendar data: ` + (error.message || error.toString()));
                            })
                            .getNamesWithCalendarEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error saving updated names:', error);
                        // Redisplay the original list from what was shown before
                        displayCurrentNames(currentNamesWithEvents);
                        alert('Error removing name: ' + (error.message || error.toString()));
                    })
                    .saveSkipLevelNames(updatedNames);
            }
        }
        
        function removeRecurringMeeting(nameToRemove) {
            console.log('Removing recurring meeting for:', nameToRemove);
            
            // Show confirmation dialog
            const confirmMessage = `⚠️ REMOVE RECURRING MEETING ⚠️\n\n` +
                                 `This action will:\n` +
                                 `• DELETE all Skip Level calendar events for "${nameToRemove}"\n` +
                                 `• DELETE all future occurrences of these meetings\n` +
                                 `• KEEP "${nameToRemove}" in the names list\n\n` +
                                 `The name will remain but without any scheduled meetings.\n\n` +
                                 `This action CANNOT be undone!\n\n` +
                                 `Are you absolutely sure you want to proceed?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Close the dropdown
            const dropdownId = 'dropdown-' + nameToRemove.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            // Show loading state
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Removing calendar meetings for "${nameToRemove}"...</p>
                </div>
            `;
            
            // Call backend function to remove just the calendar events
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Calendar meetings removed successfully, refreshing list');
                    
                    // Refresh the names list to show updated calendar status
                    google.script.run
                        .withSuccessHandler(function(refreshedNamesWithEvents) {
                            console.log('Names list refreshed after calendar removal');
                            
                            // Update cache with fresh data
                            cachedNamesWithEvents = refreshedNamesWithEvents;
                            cacheTimestamp = Date.now();
                            
                            // Display the refreshed list
                            displayCurrentNames(refreshedNamesWithEvents);
                            
                            // Show success message
                            setTimeout(() => {
                                alert(`✓ Calendar meetings for "${nameToRemove}" have been successfully removed.\nThe name remains in the list.`);
                            }, 100);
                        })
                        .withFailureHandler(function(error) {
                            console.error('Error refreshing names list after calendar removal:', error);
                            alert('Calendar meetings were removed, but there was an error refreshing the list. Please refresh the page.');
                            loadCurrentNames();
                        })
                        .getNamesWithCalendarEvents();
                })
                .withFailureHandler(function(error) {
                    console.error('Error removing calendar meetings:', error);
                    alert('Error removing calendar meetings: ' + error.message);
                    loadCurrentNames(); // Reload the original state
                })
                .removeRecurringMeetingOnly(nameToRemove);
        }
        
        function addIndividualName() {
            const nameInput = document.getElementById('newNameInput');
            const newName = nameInput.value.trim();
            
            if (!newName) {
                alert('Please enter a name.');
                return;
            }
            
            console.log('Adding individual name:', newName);
            
            // Use cached data if available, otherwise get fresh data
            if (!cachedNamesWithEvents) {
                console.log('No cached data available, refreshing...');
                // Show loading and refresh data
                document.getElementById('namesList').innerHTML = `
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading current data...</p>
                    </div>
                `;
                loadCurrentNames();
                return;
            }
            
            const currentNamesWithEvents = [...cachedNamesWithEvents];
            
            // Check if name already exists
            const existingName = currentNamesWithEvents.find(nameData => nameData.name === newName);
            if (existingName) {
                alert(`"${newName}" is already in the list.`);
                return;
            }
            
            // Show brief spinner
            document.getElementById('namesList').innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Adding "${newName}" and searching calendar...</p>
                    <div style="color: #6c757d; font-size: 12px; margin-top: 10px;">
                        Searching for existing calendar events
                    </div>
                </div>
            `;
            
            // Disable the add button and input
            const addButton = document.querySelector('button[onclick="addIndividualName()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Adding...';
            addButton.disabled = true;
            nameInput.disabled = true;
            
            // Extract just the names for saving
            const currentNames = currentNamesWithEvents.map(nameData => nameData.name);
            const updatedNames = [...currentNames, newName];
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Name added successfully with calendar search');
                    
                    // Clear cache to force reload from sheet with calendar data
                    cachedNamesWithEvents = null;
                    cacheTimestamp = null;
                    
                    // Reset form
                    addButton.textContent = originalText;
                    addButton.disabled = false;
                    nameInput.disabled = false;
                    nameInput.value = ''; // Clear the input
                    
                    // Reload the current names to show updated calendar data
                    loadCurrentNames();
                    
                    // Show success message
                    setTimeout(() => {
                        alert(`✓ "${newName}" has been successfully added with calendar event search.`);
                    }, 100);
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving updated names:', error);
                    addButton.textContent = originalText;
                    addButton.disabled = false;
                    nameInput.disabled = false;
                    // Redisplay the original list from what was shown before
                    displayCurrentNames(currentNamesWithEvents);
                    alert('Error adding name: ' + (error.message || error.toString()));
                })
                .saveSkipLevelNames(updatedNames);
        }
        
        
        // Global variable to store meeting slots
        let currentMeetingSlots = [];
        
        // Global variable to track unsaved changes
        let hasUnsavedChanges = false;
        let originalMeetingSlots = [];
        
        function markUnsavedChanges() {
            hasUnsavedChanges = true;
        }
        
        function clearUnsavedChanges() {
            hasUnsavedChanges = false;
            originalMeetingSlots = JSON.parse(JSON.stringify(currentMeetingSlots));
        }
        
        function checkForUnsavedChanges() {
            return JSON.stringify(currentMeetingSlots) !== JSON.stringify(originalMeetingSlots);
        }
        
        function loadMeetingSlots() {
            console.log('Loading meeting slots');
            google.script.run
                .withSuccessHandler(function(slots) {
                    console.log('Loaded meeting slots:', slots);
                    currentMeetingSlots = slots || [];
                    originalMeetingSlots = JSON.parse(JSON.stringify(currentMeetingSlots));
                    hasUnsavedChanges = false;
                    displayMeetingSlots();
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading meeting slots:', error);
                    document.getElementById('meetingSlotsList').innerHTML = `
                        <div style="color: red; text-align: center;">
                            Error loading meeting slots: ${error.message || error.toString()}
                        </div>
                    `;
                })
                .getMeetingSlots();
        }
        
        function displayMeetingSlots() {
            const slotsList = document.getElementById('meetingSlotsList');
            
            if (currentMeetingSlots.length === 0) {
                slotsList.innerHTML = `
                    <div style="color: #666; text-align: center; font-style: italic; padding: 20px; border: 1px dashed #ccc; border-radius: 4px;">
                        No meeting slots configured. Add your first slot below.
                    </div>
                `;
            } else {
                let html = `
                    <div style="margin-bottom: 15px; font-weight: bold; color: #333;">
                        Configured Meeting Slots (${currentMeetingSlots.length}):
                    </div>
                `;
                
                currentMeetingSlots.forEach((slot, index) => {
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px; background-color: #fafafa;">
                            <div>
                                <strong>Day:</strong> ${escapeHtml(slot.dayOfWeek)}
                            </div>
                            <div>
                                <strong>Time:</strong> ${formatTimeHHMM(slot.time)}
                            </div>
                            <div>
                                <strong>Duration:</strong> ${escapeHtml(slot.duration)} mins
                            </div>
                            <div>
                                <button onclick="editMeetingSlot(${index})" style="background: #ffc107; color: #000; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Edit</button>
                            </div>
                            <div>
                                <button onclick="deleteMeetingSlot(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                slotsList.innerHTML = html;
            }
        }
        
        function addMeetingSlot() {
            const day = document.getElementById('newSlotDay').value;
            const time = document.getElementById('newSlotTime').value;
            const duration = document.getElementById('newSlotDuration').value;
            
            if (!day || !time || !duration) {
                alert('Please fill in all fields for the meeting slot.');
                return;
            }
            
            if (parseInt(duration) < 15 || parseInt(duration) > 480) {
                alert('Duration must be between 15 and 480 minutes.');
                return;
            }
            
            const newSlot = {
                dayOfWeek: day,
                time: time,
                duration: duration
            };
            
            currentMeetingSlots.push(newSlot);
            markUnsavedChanges();
            displayMeetingSlots();
            
            // Clear form
            document.getElementById('newSlotTime').value = '';
            document.getElementById('newSlotDuration').value = '';
        }
        
        function editMeetingSlot(index) {
            const slot = currentMeetingSlots[index];
            if (!slot) return;
            
            const newDay = prompt('Day of Week:', slot.dayOfWeek);
            if (newDay === null) return; // User cancelled
            
            const newTime = prompt('Time (HH:MM format):', slot.time);
            if (newTime === null) return; // User cancelled
            
            const newDuration = prompt('Duration (minutes):', slot.duration);
            if (newDuration === null) return; // User cancelled
            
            // Validate inputs
            if (!newDay || !newTime || !newDuration) {
                alert('All fields are required.');
                return;
            }
            
            if (parseInt(newDuration) < 15 || parseInt(newDuration) > 480) {
                alert('Duration must be between 15 and 480 minutes.');
                return;
            }
            
            // Update the slot
            currentMeetingSlots[index] = {
                dayOfWeek: newDay,
                time: newTime,
                duration: newDuration
            };
            
            markUnsavedChanges();
            displayMeetingSlots();
        }
        
        function deleteMeetingSlot(index) {
            const slot = currentMeetingSlots[index];
            if (!slot) return;
            
            if (confirm(`Delete meeting slot: ${slot.dayOfWeek} at ${slot.time} for ${slot.duration} minutes?`)) {
                currentMeetingSlots.splice(index, 1);
                markUnsavedChanges();
                displayMeetingSlots();
            }
        }
        
        function saveConfiguration() {
            console.log('Saving configuration');
            
            // Check for unsaved changes and show warning
            if (checkForUnsavedChanges()) {
                const confirmSave = confirm('You have unsaved changes to your meeting slots. Are you sure you want to save these changes?');
                if (!confirmSave) {
                    return; // User cancelled the save
                }
            }
            
            // Show loading state
            const saveButton = document.querySelector('button[onclick="saveConfiguration()"]');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            // Save meeting slots
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Configuration saved successfully:', result);
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                    clearUnsavedChanges(); // Clear the unsaved changes flag
                    alert('Configuration saved successfully!');
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving configuration:', error);
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                    alert('Error saving configuration: ' + (error.message || error.toString()));
                })
                .saveMeetingSlots(currentMeetingSlots);
        }
        
        
        
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked tab
            const clickedTab = event.target;
            clickedTab.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'properties') {
                loadCurrentProperties();
            }
        }
        
        function loadCurrentProperties() {
            console.log('Properties tab accessed - Loading Recurring Interval from CalendarUtilities Google Sheet...');
            
            const recurringIntervalInput = document.getElementById('recurringIntervalInput');
            
            if (!recurringIntervalInput) {
                console.error('Recurring interval input field not found');
                return;
            }
            
            // Set loading state
            recurringIntervalInput.value = '';
            recurringIntervalInput.placeholder = 'Loading...';
            recurringIntervalInput.disabled = true;
            
            // Read the Recurring Interval property from Google Sheet Properties tab
            google.script.run
                .withSuccessHandler(function(propertyResult) {
                    console.log('Google Sheet Properties tab accessed. Result:', propertyResult);
                    
                    let finalValue = 8; // Default fallback
                    
                    if (propertyResult && propertyResult.found && propertyResult.value !== null && propertyResult.value !== undefined) {
                        const sheetValue = parseInt(propertyResult.value);
                        if (!isNaN(sheetValue) && sheetValue >= 1 && sheetValue <= 26) {
                            finalValue = sheetValue;
                            console.log(`SUCCESS: Read Recurring Interval from Google Sheet Properties tab: ${finalValue}`);
                        } else {
                            console.log(`Invalid value in Google Sheet (${propertyResult.value}), using default: 8`);
                        }
                    } else {
                        console.log('Recurring Interval property not found in Google Sheet Properties tab, using default: 8');
                    }
                    
                    // Update the input field with the value from Google Sheet
                    recurringIntervalInput.value = finalValue;
                    recurringIntervalInput.placeholder = '';
                    recurringIntervalInput.disabled = false;
                    
                    // Validate the value
                    validateRecurringInterval();
                    
                    console.log(`Recurring Interval input field populated with value: ${finalValue}`);
                })
                .withFailureHandler(function(error) {
                    console.error('FAILED to read from Google Sheet Properties tab:', error);
                    
                    // Use default value on failure
                    recurringIntervalInput.value = 8;
                    recurringIntervalInput.placeholder = '';
                    recurringIntervalInput.disabled = false;
                    
                    validateRecurringInterval();
                    
                    console.log('Using default Recurring Interval value: 8');
                })
                .getProperty('Recurring Interval');
        }
        
        function validateRecurringInterval() {
            const input = document.getElementById('recurringIntervalInput');
            const statusElement = document.getElementById('recurringIntervalStatus');
            const value = parseInt(input.value);
            
            if (isNaN(value) || value < 1 || value > 26) {
                statusElement.innerHTML = '<span style="color: #dc3545; font-size: 12px;">⚠️ Must be 1-26</span>';
                statusElement.style.display = 'block';
                return false;
            } else {
                statusElement.innerHTML = '<span style="color: #28a745; font-size: 12px;">✓ Valid</span>';
                statusElement.style.display = 'block';
                return true;
            }
        }
        
        function autoCalculateRecurringInterval() {
            console.log('Auto-calculating optimal recurring interval');
            
            const input = document.getElementById('recurringIntervalInput');
            const autoCalcButton = document.getElementById('autoCalculateBtn');
            const statusElement = document.getElementById('propertiesStatus');
            
            // Show loading state on button
            const originalButtonText = autoCalcButton.innerHTML;
            autoCalcButton.innerHTML = `
                <div style="display: inline-flex; align-items: center; gap: 8px;">
                    <div style="border: 2px solid #f3f3f3; border-top: 2px solid var(--secondary-600); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>
                    Calculating...
                </div>
            `;
            autoCalcButton.disabled = true;
            
            statusElement.innerHTML = `
                <div style="background-color: var(--bg-secondary); color: var(--gray-700); border: 1px solid var(--gray-300); padding: var(--space-md); border-radius: var(--radius-md);">
                    Calculating optimal recurring interval based on current data...
                </div>
            `;
            statusElement.style.display = 'block';
            
            // Call the backend function
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Auto-calculation result:', result);
                    
                    // Restore button
                    autoCalcButton.innerHTML = originalButtonText;
                    autoCalcButton.disabled = false;
                    
                    // Update the input field with calculated value
                    input.value = result.calculatedValue;
                    
                    // Validate the new value
                    validateRecurringInterval();
                    
                    // Hide status element
                    statusElement.style.display = 'none';
                })
                .withFailureHandler(function(error) {
                    console.error('Error in auto-calculation:', error);
                    
                    // Restore button
                    autoCalcButton.innerHTML = originalButtonText;
                    autoCalcButton.disabled = false;
                    
                    // Show error message
                    statusElement.innerHTML = `
                        <div style="background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: var(--space-md); border-radius: var(--radius-md);">
                            <strong>Auto-Calculation Error:</strong><br>
                            ${error.message || error.toString()}
                        </div>
                    `;
                })
                .calculateOptimalRecurringInterval();
        }
        
        function saveRecurringInterval() {
            console.log('Saving recurring interval');
            
            const input = document.getElementById('recurringIntervalInput');
            const saveButton = document.getElementById('savePropertiesBtn');
            const statusElement = document.getElementById('propertiesStatus');
            
            // Get the value, default to 8 if empty or invalid
            let value = parseInt(input.value);
            if (isNaN(value) || input.value === '') {
                value = 8;
                input.value = 8; // Set the input to show the default
            }
            
            // Validate input
            if (!validateRecurringInterval()) {
                statusElement.innerHTML = `
                    <div style="background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: var(--space-md); border-radius: var(--radius-md);">
                        <strong>Validation Error:</strong> Recurring interval must be between 1 and 26 weeks.
                    </div>
                `;
                statusElement.style.display = 'block';
                return;
            }
            
            // Show saving state
            const originalButtonText = saveButton.innerHTML;
            saveButton.innerHTML = `
                <div style="display: inline-flex; align-items: center; gap: 8px;">
                    <div style="border: 2px solid #f3f3f3; border-top: 2px solid var(--success-600); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite;"></div>
                    Saving...
                </div>
            `;
            saveButton.disabled = true;
            
            statusElement.innerHTML = `
                <div style="background-color: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; padding: var(--space-md); border-radius: var(--radius-md);">
                    Saving recurring interval...
                </div>
            `;
            statusElement.style.display = 'block';
            
            // Save the property
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Recurring interval saved:', result);
                    
                    // Restore button
                    saveButton.innerHTML = originalButtonText;
                    saveButton.disabled = false;
                    
                    // Show success message
                    statusElement.innerHTML = `
                        <div style="background-color: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; padding: var(--space-md); border-radius: var(--radius-md);">
                            <strong>Success!</strong> ${result.message}
                        </div>
                    `;
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 3000);
                })
                .withFailureHandler(function(error) {
                    console.error('Error saving recurring interval:', error);
                    
                    // Restore button
                    saveButton.innerHTML = originalButtonText;
                    saveButton.disabled = false;
                    
                    // Show error message
                    statusElement.innerHTML = `
                        <div style="background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: var(--space-md); border-radius: var(--radius-md);">
                            <strong>Error:</strong> ${error.message || error.toString()}
                        </div>
                    `;
                })
                .setRecurringInterval(value);
        }
        
        
        function goBackToMenu() {
            console.log('Going back to main menu');
            const container = document.querySelector('.container');
            container.style.maxWidth = '400px'; // Reset to original width
            container.innerHTML = `
                <h1>Andy's Calendar Utilities</h1>
                
                <button class="button full" onclick="handleNames()">
                    Skip Levels
                </button>
            `;
        }
        
        function onFailure(error) {
            console.error('Error:', error);
            alert('An error occurred: ' + error.message);
        }
    </script>
</body>
</html>